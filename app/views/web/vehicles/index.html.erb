<div class="d-flex flex-wrap align-items-center gap-2 mb-4">
  <div class="d-flex align-items-center gap-3">
    <h1 class="h3 mb-0">
      Vehicles
      <% if request.path == discarded_vehicles_path %>
        <small class="text-warning">(Eliminados)</small>
      <% end %>
    </h1>
    <% if @pagy&.count %>
      <span class="badge rounded-pill text-bg-light"><%= @pagy.count %> total</span>
    <% end %>
  </div>

  <div class="ms-auto d-flex gap-2">
    <% if request.path == discarded_vehicles_path %>
      <%= link_to 'Ver activos', vehicles_path, class: 'btn btn-outline-secondary' %>
    <% else %>
      <%= link_to 'Ver eliminados', discarded_vehicles_path, class: 'btn btn-outline-warning' %>
    <% end %>
    <%= link_to 'Nuevo', new_vehicle_path, class: 'btn btn-primary' %>
  </div>
</div>

<div class="card p-4 mb-3 shadow-sm">
  <div class="card-body">
    <%= form_with url: vehicles_path, method: :get, local: true, class: "row g-2 align-items-end" do |f| %>
      <div class="col-12 col-md-4">
        <%= f.label :q, 'BÃºsqueda', class: 'form-label' %>
        <%= f.text_field :q, value: params[:q], class: 'form-control', placeholder: 'brand, model, plate, vin' %>
      </div>

      <div class="col-6 col-md-3">
        <%= f.label :status, 'Status', class: 'form-label' %>
        <%= f.select :status,
          options_for_select([['(Todos)', '']] + Vehicle.statuses.keys.map { |k| [k.humanize, k] }, params[:status]),
          {},
          class: 'form-select' %>
      </div>

      <div class="col-6 col-md-2">
        <%= f.label :brand, 'Brand', class: 'form-label' %>
        <%= f.text_field :brand, value: params[:brand], class: 'form-control', placeholder: 'e.g. Toyota' %>
      </div>

      <div class="col-6 col-md-2">
        <%= f.label :year, 'Year', class: 'form-label' %>
        <%= f.number_field :year, value: params[:year], class: 'form-control', placeholder: 'e.g. 2022' %>
      </div>

      <div class="col-6 col-md-1 d-grid">
        <%= f.submit 'Filtrar', class: 'btn btn-outline-secondary' %>
      </div>

      <%# Chips de filtros activos %>
      <% active = { q: params[:q], status: params[:status], brand: params[:brand], year: params[:year] }.compact_blank %>
      <% if active.present? %>
        <div class="col-12 mt-2 d-flex flex-wrap align-items-center gap-2">
          <span class="text-muted small">Filtros:</span>

          <%# helper para construir URL removiendo 1 filtro %>
          <% def remove_filter_url(key)
               url_for(params.permit(:q, :status, :brand, :year, :page).to_h.merge(key => nil, page: nil).compact_blank)
             end %>

          <% active.each do |k, v| %>
            <a href="<%= remove_filter_url(k) %>" class="badge rounded-pill text-bg-light text-decoration-none">
              <strong class="text-capitalize"><%= k %>:</strong> <%= v %> &times;
            </a>
          <% end %>

          <%= link_to 'Limpiar todo', vehicles_path, class: 'btn btn-sm btn-link text-decoration-none' %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<div class="card p-4 shadow-sm">
  <% if @vehicles.blank? %>
    <div class="card-body text-center py-5">
      <div class="display-6 mb-2">ðŸš—</div>
      <h5 class="mb-1">Sin resultados</h5>
      <p class="text-muted mb-3">Ajusta los filtros o crea un vehÃ­culo nuevo.</p>
      <%= link_to 'Crear vehÃ­culo', new_vehicle_path, class: 'btn btn-primary' %>
    </div>
  <% else %>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0 table-compact">
        <thead class="table-light sticky-top">
          <tr>
            <th>Brand</th>
            <th>Model</th>
            <th class="text-nowrap">Year</th>
            <th>Plate</th>
            <th class="d-none d-md-table-cell">VIN</th>
            <th>Status</th>
            <th class="text-end"></th>
          </tr>
        </thead>
        <tbody>
          <% @vehicles.each do |v| %>
            <tr>
              <td class="fw-semibold"><%= v.brand %></td>
              <td><%= v.model %></td>
              <td class="text-nowrap"><%= v.year %></td>
              <td><code><%= v.plate %></code></td>

              <td class="d-none d-md-table-cell">
                <% vin = v.vin.to_s %>
                <span class="text-muted text-truncate d-inline-block" style="max-width: 240px;" title="<%= vin %>">
                  <%= vin.presence || 'â€”' %>
                </span>
              </td>

              <td>
                <span class="badge <%= vehicle_status_badge_class(v.status) %>"><%= v.status.humanize %></span>
              </td>

              <td class="text-end">
                <% if v.discarded? %>
                  <div class="btn-group">
                    <%= button_to 'Restaurar', restore_vehicle_path(v),
                          method: :post,
                          form: { data: { turbo_confirm: 'Â¿Restaurar este vehÃ­culo?' } },
                          class: 'btn btn-sm btn-outline-success' %>
                  </div>
                <% else %>
                  <div class="btn-group">
                    <%= link_to 'Ver', v, class: 'btn btn-sm btn-outline-primary' %>
                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                      <span class="visually-hidden">MÃ¡s</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li><%= link_to 'Editar', edit_vehicle_path(v), class: 'dropdown-item' %></li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <%= button_to 'Eliminar', v,
                                      method: :delete,
                                      form: { data: { turbo_confirm: 'Â¿Seguro que deseas eliminar este vehÃ­culo?' } },
                                      class: 'dropdown-item text-danger' %>
                      </li>
                    </ul>
                  </div>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="card-footer d-flex flex-wrap gap-2 align-items-center">
      <% if @pagy %>
        <div class="text-muted small me-auto"><%= raw pagy_info(@pagy) %></div>
        <div class="ms-auto"><%= raw pagy_bootstrap_nav(@pagy) %></div>
      <% end %>
    </div>
  <% end %>
</div>
