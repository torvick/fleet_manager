<div class="container-fluid py-4">
  <div class="d-flex flex-wrap align-items-center gap-2 mb-4">
    <h1 class="h3 mb-0">Reporte de Mantenimiento</h1>
    <div class="ms-auto d-flex gap-2">
      <%= link_to 'Volver a VehÃ­culos', root_path, class: 'btn btn-outline-secondary' %>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card p-4 mb-4 shadow-sm">
    <div class="card-body">
      <%= form_with url: maintenance_summary_report_path, method: :get, local: true, class: "row g-3 align-items-end" do |f| %>
        <div class="col-12 col-md-3">
          <%= f.label :from, 'Fecha desde', class: 'form-label' %>
          <%= f.date_field :from, value: @from, class: 'form-control' %>
        </div>

        <div class="col-12 col-md-3">
          <%= f.label :to, 'Fecha hasta', class: 'form-label' %>
          <%= f.date_field :to, value: @to, class: 'form-control' %>
        </div>

        <div class="col-12 col-md-3">
          <%= f.label :vehicle_id, 'VehÃ­culo (opcional)', class: 'form-label' %>
          <%= f.select :vehicle_id,
            options_for_select([['Todos los vehÃ­culos', '']] + @vehicles.map { |v| ["#{v.brand} #{v.model} - #{v.plate}", v.id] }, @vehicle_id),
            {},
            class: 'form-select' %>
        </div>

        <div class="col-12 col-md-3 d-flex gap-2">
          <div class="flex-fill">
            <%= f.submit 'Generar Reporte', class: 'btn btn-primary w-100' %>
          </div>
          <div class="flex-fill">
            <%= link_to 'Limpiar', maintenance_summary_report_path, class: 'btn btn-outline-secondary w-100' %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Botones de exportaciÃ³n -->
  <div class="card p-3 mb-4 shadow-sm bg-light">
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="fw-semibold me-2">Exportar:</span>
      <%= link_to maintenance_summary_report_path(format: :csv, from: @from, to: @to, vehicle_id: @vehicle_id),
                  class: 'btn btn-success btn-sm' do %>
        <i class="bi bi-file-earmark-spreadsheet"></i> Descargar CSV
      <% end %>
      <%= link_to maintenance_summary_report_path(format: :xlsx, from: @from, to: @to, vehicle_id: @vehicle_id),
                  class: 'btn btn-success btn-sm' do %>
        <i class="bi bi-file-earmark-excel"></i> Descargar Excel
      <% end %>
    </div>
  </div>

  <!-- Totales -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="card-title text-muted">Ã“rdenes Totales</h5>
          <p class="display-4 mb-0 text-primary"><%= @results[:totals][:orders_count] %></p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="card-title text-muted">Costo Total</h5>
          <p class="display-4 mb-0 text-success">$<%= number_with_precision(@results[:totals][:total_cost_cents] / 100.0, precision: 2, delimiter: ',') %></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Resumen por Estado -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Resumen por Estado</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th>Estado</th>
              <th class="text-end">Cantidad de Servicios</th>
              <th class="text-end">Costo Total</th>
            </tr>
          </thead>
          <tbody>
            <% @results[:breakdown_by_status].each do |row| %>
              <tr>
                <td><span class="badge bg-secondary"><%= row[:key] %></span></td>
                <td class="text-end"><%= row[:services_count] %></td>
                <td class="text-end">$<%= number_with_precision(row[:total_cost_cents] / 100.0, precision: 2, delimiter: ',') %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Resumen por VehÃ­culo -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">Resumen por VehÃ­culo</h5>
    </div>
    <div class="card-body">
      <% if @results[:breakdown_by_vehicle].empty? %>
        <p class="text-muted text-center mb-0">No hay datos para mostrar</p>
      <% else %>
        <div class="table-responsive">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Placa</th>
                <th class="text-end">Cantidad de Servicios</th>
                <th class="text-end">Costo Total</th>
              </tr>
            </thead>
            <tbody>
              <% @results[:breakdown_by_vehicle].each do |row| %>
                <tr>
                  <td><%= row[:vehicle_id] %></td>
                  <td><%= row[:brand] %></td>
                  <td><%= row[:model] %></td>
                  <td><code><%= row[:plate] %></code></td>
                  <td class="text-end"><%= row[:services_count] %></td>
                  <td class="text-end">$<%= number_with_precision(row[:total_cost_cents] / 100.0, precision: 2, delimiter: ',') %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Top VehÃ­culos por Costo -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">Top 3 VehÃ­culos por Costo</h5>
    </div>
    <div class="card-body">
      <% if @results[:top_vehicles_by_cost].empty? %>
        <p class="text-muted text-center mb-0">No hay datos para mostrar</p>
      <% else %>
        <div class="table-responsive">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-light">
              <tr>
                <th>Ranking</th>
                <th>ID</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Placa</th>
                <th class="text-end">Cantidad de Servicios</th>
                <th class="text-end">Costo Total</th>
              </tr>
            </thead>
            <tbody>
              <% @results[:top_vehicles_by_cost].each_with_index do |row, index| %>
                <tr>
                  <td>
                    <% if index == 0 %>
                      <span class="badge bg-warning text-dark">ðŸ¥‡ 1Â°</span>
                    <% elsif index == 1 %>
                      <span class="badge bg-secondary">ðŸ¥ˆ 2Â°</span>
                    <% elsif index == 2 %>
                      <span class="badge bg-light text-dark">ðŸ¥‰ 3Â°</span>
                    <% end %>
                  </td>
                  <td><%= row[:vehicle_id] %></td>
                  <td><%= row[:brand] %></td>
                  <td><%= row[:model] %></td>
                  <td><code><%= row[:plate] %></code></td>
                  <td class="text-end"><%= row[:services_count] %></td>
                  <td class="text-end fw-bold">$<%= number_with_precision(row[:total_cost_cents] / 100.0, precision: 2, delimiter: ',') %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>
</div>